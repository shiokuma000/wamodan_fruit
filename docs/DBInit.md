# DB初期化処理設計書

## 1. 概要
アプリケーション起動時に必要なデータベース（H2）を自動で初期化する処理。  
- テーブル作成：NAME, PRICE, DESC_TEXT, IMAGE  
- 初期データ挿入：3つの果物（NAME, PRICE, DESC_TEXT, IMAGE）

---

## 2. 使用クラス・ファイル構成

| クラス／ファイル          | 説明                                      |
|--------------------------|-------------------------------------------|
| `DBInitListener.java`    | サーバー起動時に DB 初期化処理を呼び出すリスナー |
| `DBInit.java`            | DB 接続、テーブル作成、初期データ挿入を行うクラス |

---

## 3. 初期化処理フロー（MVC風の色分け）

**色分け情報：**  
- Listener（サーブレットリスナー） → 緑  
- Model（DBInit） → 青  
- SQLテーブル   →  黄

### 3-1. 処理フロー図
[![DB初期化処理図](drawio/db.png)](drawio/db.png)

※ 画像をクリックすると拡大表示されます。


---

## 4. 処理分岐詳細

| 処理               | 処理内容                                                      | 成功時                   | 失敗時                     |
|-------------------|---------------------------------------------------------------|--------------------------|----------------------------|
| DB 接続            | `DBInit.getConnection()` により H2 DB へ接続                  | 接続成功                 | 例外発生 → ログに出力      |
| テーブル作成        | `CREATE TABLE IF NOT EXISTS` でテーブル生成                 | テーブル作成完了          | 例外発生 → ログに出力      |
| 初期データ挿入      | 存在確認付きで INSERT                                        | データ挿入成功            | 例外発生 → ログに出力      |
| 初期化完了メッセージ  | `System.out.println` で出力                                   | "wamodan テーブル初期化完了" | -                          |

---

## 5. 順序付き処理概要

1. サーバー起動  
2. `DBInitListener.contextInitialized()` 呼び出し  
   - `/data` フォルダパス取得  
   - `DBInit.dataFolderPath` にセット  
3. `DBInit.initialize()` 呼び出し  
   - DB 接続 (`getConnection()`)  
   - テーブル作成（NAME, PRICE, DESC_TEXT, IMAGE）  
   - 初期データ挿入（NAME, PRICE, DESC_TEXT, IMAGE）  
4. 初期化完了メッセージ出力  
